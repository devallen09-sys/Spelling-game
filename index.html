<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spelling Game</title>
  <style>
    :root { --radius: 14px; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: #f7f7fb; color: #111; line-height: 1.45; }
    header { position: sticky; top: 0; z-index: 10; background: white; border-bottom: 1px solid #ececf3; padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    header h1 { font-size: 18px; margin: 0; }
    main { padding: 16px; max-width: 880px; margin: 0 auto; }
    .card { background: white; border: 1px solid #ececf3; border-radius: var(--radius); padding: 16px; margin: 12px 0; box-shadow: 0 6px 20px rgba(0,0,0,0.04); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    label { font-weight: 600; }
    input[type="text"], textarea, select { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #d9dbe7; font-size: 16px; background: #fff; }
    textarea { min-height: 120px; resize: vertical; }
    button { appearance: none; border: none; cursor: pointer; font-weight: 600; padding: 12px 16px; border-radius: 12px; background: #111; color: white; font-size: 16px; }
    button.ghost { background: #f0f1f6; color: #111; }
    button.outline { background: white; border: 1px solid #d9dbe7; color: #111; }
    button.small { padding: 10px 12px; font-size: 14px; }
    .muted { color: #555; }
    .hidden { display: none !important; }
    .center { text-align: center; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 640px) { .grid-2 { grid-template-columns: 1fr; } }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 999px; border: 1px solid #e6e6ef; background: #fafbff; font-size: 13px; color: #444; }
    .key { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding: 1px 6px; border-radius: 6px; background: #111; color: #fff; font-size: 12px; }
    .progress { height: 10px; background: #eee; border-radius: 999px; overflow: hidden; }
    .progress > div { height: 100%; width: 0%; background: #111; transition: width .25s ease; }
    .list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
    .chip { background: #fafbff; border: 1px solid #e6e6ef; border-radius: 999px; padding: 8px 12px; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; }
    .result-good { color: #0c7a3a; }
    .result-bad { color: #b20027; }
    .kbd { border: 1px solid #d9dbe7; border-bottom-width: 3px; padding: 8px 10px; border-radius: 10px; background: #fff; min-width: 180px; }
    .footer { font-size: 13px; color: #555; text-align: center; padding: 24px 0 40px; }
    .timer { font-variant-numeric: tabular-nums; font-weight: 700; }
  </style>
</head>
<body>
  <header>
    <h1>Spelling Game</h1>
    <div class="row">
      <button id="btnEdit" class="outline small">Edit words</button>
      <button id="btnShare" class="ghost small" title="Create a shareable link for this week's list">Share link</button>
      <button id="btnHow" class="ghost small">How to play</button>
    </div>
  </header>

  <main>
    <section id="how" class="card hidden">
      <h2>How it works</h2>
      <ol>
        <li>Tap <strong>Edit words</strong> to paste this week's list. (It saves on this device.)</li>
        <li>Choose a mode and press <strong>Start</strong>.</li>
        <li>Tap <strong>Speak</strong> ðŸ”Š to hear the word, then type the spelling and hit <span class="key">Enter</span>.</li>
      </ol>
      <p class="muted">Tip: Long-press the ðŸŽ² button to shuffle the word order.</p>
      <p class="muted">Share a one-tap link that preloads this week's words using <em>Share link</em>.</p>
    </section>

    <section id="editor" class="card hidden">
      <div class="row" style="justify-content: space-between;">
        <h2 style="margin:0">Weekly Words</h2>
        <button id="closeEditor" class="ghost small">Done</button>
      </div>
      <p class="muted">Paste one word per line. Optional: add a sentence after a comma, like <em>beautiful, You have a beautiful smile.</em></p>
      <textarea id="wordInput" placeholder="cat
because, I like pizza because it tastes good.
friend
mountain, We climbed the tall mountain.
..."></textarea>
      <div class="row" style="margin-top:10px; justify-content: space-between;">
        <div class="row" style="gap:8px;">
          <button id="saveWords">Save</button>
          <button id="shuffleWords" class="ghost">Shuffle</button>
          <button id="clearWords" class="ghost">Clear</button>
        </div>
        <div class="row" style="gap:8px;">
          <button id="exportWords" class="outline">Export</button>
          <input id="importFile" class="hidden" type="file" accept=".json" />
          <button id="importBtn" class="ghost">Import</button>
        </div>
      </div>
      <div id="currentList" class="card" style="margin-top:12px;">
        <strong>Current list</strong>
        <div class="list" id="listPreview"></div>
      </div>
    </section>

    <section id="setup" class="card">
      <h2>Start a Practice or Test</h2>
      <div class="grid-2">
        <div>
          <label for="mode">Mode</label>
          <select id="mode">
            <option value="dictation">Dictation (hear the word)</option>
            <option value="sentence">Sentence (blank to fill in)</option>
          </select>
        </div>
        <div>
          <label for="voiceSel">Voice (optional)</label>
          <select id="voiceSel"></select>
        </div>
      </div>
      <div class="grid-2" style="margin-top:12px;">
        <div>
          <label><input type="checkbox" id="timerToggle" /> Enable timer per word (15s)</label>
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="startBtn">Start</button>
        <button id="practiceBtn" class="ghost">Practice (no scoring)</button>
        <button id="randomize" class="outline" title="Shuffle order">ðŸŽ² Shuffle</button>
      </div>
      <p class="muted" style="margin-top:8px;">Words on this device: <span id="countWords">0</span></p>
    </section>

    <section id="play" class="card hidden">
      <div class="row" style="justify-content: space-between; align-items: center;">
        <div class="pill"><span id="pillMode">Dictation</span> â€¢ <span id="pillProgress">1/10</span></div>
        <div class="row" style="gap:8px; align-items:center;">
          <span id="timer" class="timer hidden">15</span>
          <button id="speakBtn" class="outline small">ðŸ”Š Speak</button>
          <button id="repeatBtn" class="ghost small">Repeat</button>
        </div>
      </div>

      <div class="progress" style="margin:12px 0 14px;"><div id="bar"></div></div>

      <div id="sentenceWrap" class="hidden">
        <p id="sentence" class="kbd" aria-live="polite"></p>
      </div>

      <label for="answer">Type the word</label>
      <input id="answer" type="text" autocomplete="off" placeholder="Type here and press Enter" />
      <div class="row" style="margin-top:10px;">
        <button id="skipBtn" class="ghost">Skip</button>
        <button id="revealBtn" class="outline">Reveal</button>
      </div>
      <p id="feedback" class="muted" aria-live="polite" style="min-height:24px;"></p>
    </section>

    <section id="results" class="card hidden">
      <h2>Results</h2>
      <p class="muted" id="scoreLine"></p>
      <div id="missedWrap" class="hidden">
        <h3>Review missed words</h3>
        <div id="missedList"></div>
      </div>
      <h3 style="margin-top:16px;">History on this device</h3>
      <div id="historyList" class="muted"></div>
      <div class="row" style="margin-top:12px; justify-content: space-between;">
        <button id="retryBtn">Retry missed</button>
        <button id="restartBtn" class="ghost">New round</button>
      </div>
    </section>

    <p class="footer">Made for weekly word lists. Your changes auto-save in this browser. Share this week's list with the "Share link" button.</p>
  </main>

  <script>
    // ------- Data handling -------
    const LS_KEY = "spelling_words_v2";
    const LS_HIST = "spelling_history_v1";

    function defaultWords() {
      return [
        {w:"because", s:"I like pizza because it tastes good."},
        {w:"friend", s:"My friend came over to play."},
        {w:"beautiful", s:"You have a beautiful smile."},
        {w:"mountain", s:"We climbed the tall mountain."},
        {w:"important", s:"It is important to study."},
        {w:"family", s:"My family is going on vacation."},
        {w:"practice", s:"We practice spelling every day."},
        {w:"picture", s:"I drew a picture of a house."},
        {w:"different", s:"We chose different flavors of ice cream."},
        {w:"through", s:"We walked through the park."}
      ];
    }
    function loadWords() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return defaultWords();
        const arr = JSON.parse(raw);
        if (Array.isArray(arr) && arr.every(x => x && typeof x.w === 'string')) return arr;
      } catch {}
      return defaultWords();
    }
    function saveWords(list) {
      localStorage.setItem(LS_KEY, JSON.stringify(list));
      renderListPreview();
      updateCount();
    }
    function parseTextArea(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const out = [];
      for (const line of lines) {
        const [w, ...rest] = line.split(",");
        const word = (w || "").trim();
        const s = rest.join(",").trim();
        if (word) out.push({ w: word, s: s || "" });
      }
      return out;
    }
    function exportJSON() {
      const data = loadWords();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "spelling-words.json";
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    }
    function renderListPreview() {
      const list = loadWords();
      const root = document.getElementById("listPreview");
      root.innerHTML = "";
      for (const item of list) {
        const div = document.createElement("div");
        div.className = "chip";
        div.textContent = item.w;
        root.appendChild(div);
      }
    }
    function updateCount() {
      const n = loadWords().length;
      document.getElementById("countWords").textContent = String(n);
    }

    // ------- History -------
    function addHistory(entry) {
      const hist = getHistory();
      hist.unshift(entry);
      while (hist.length > 50) hist.pop();
      localStorage.setItem(LS_HIST, JSON.stringify(hist));
    }
    function getHistory() {
      try {
        const raw = localStorage.getItem(LS_HIST);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }
    function renderHistory() {
      const hist = getHistory();
      const root = document.getElementById("historyList");
      if (!hist.length) { root.textContent = "No history yet."; return; }
      root.innerHTML = "";
      hist.forEach(h => {
        const p = document.createElement("p");
